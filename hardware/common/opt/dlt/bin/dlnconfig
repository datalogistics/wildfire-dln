#!/bin/bash

function help() {
	echo "Incorrect number of arguments"
	echo "usage: dlnconfig stop"
	echo "       dlnconfig start <mode> <host> <internal-if>"
	echo ""
	echo "command     - Start or stop the service [start|stop]"
	echo "mode        - Set the type of service [base|ferry]"
	echo "host        - Set the hostname of the system"
	echo "internal-if - Interface for the internal network"
	exit -1
}

if [ "$#" -lt 1 ]; then
	echo $@
	help
fi

if [[ "$1" == "stop" ]]; then
	echo "Halting services for configuration"
	systemctl stop dnsmasq-extern &> /dev/null
	for s in $(systemctl list-units dnsmasq-intern@*.service --all --no-legend | awk '{print $1}'); do
		systemctl disable --now $s
	done
	systemctl stop dnsmasq-intern &> /dev/null
	systemctl stop unis &> /dev/null
	
	echo "Disabling services"
	systemctl disable --now dhcpcd &> /dev/null
	systemctl disable --now dlnagent@ferry 2>&1 > /dev/null
	systemctl disable --now dlnagent@base 2>&1 > /dev/null
	systemctl disable --now dlnprune &> /dev/null
	systemctl disable --now dlnloader 2>&1 > /dev/null
	systemctl disable --now idms 2>&1 > /dev/null
	systemctl disable --now dnsmasq-intern &> /dev/null
	systemctl disable --now dln-sysmon.timer &> /dev/null
	for s in $(systemctl list-units dln-netmon@*.timer --all --no-legend | awk '{print $1}'); do
		systemctl disable --now $s
	done
else
	rm -rf /depot/unis/*
	MESHIF=$4
	MODE=$2	
	HOST=$3
	CLIENTIF=$5

	echo "Configuring system:"
	echo "    Hostname:           $HOST"
	echo "    Mode:               $MODE"
	echo "    Internal interface: $MESHIF"
	if [[ ! -z "${CLIENTIF// }" ]]; then
		echo "    External interface: $CLIENTIF"
		echo "Enabling monitor"
		systemctl enable --now dln-sysmon.timer
		systemctl enable --now dln-netmon@$MESHIF.timer
		systemctl enable --now dln-netmon@$CLIENTIF.timer
	fi

	hostname $HOST
	sed -i "s/127\.0\.1\.1.*/127.0.1.1\t$HOST/g" /etc/hosts
	if [[ "$MODE" == "ferry" ]]; then
		rm "/var/run/wpa_supplicant/$MESHIF" &> /dev/null
	fi
	echo "Network configured, restarting network..."
	systemctl start dnsmasq-extern
	systemctl start unis
	systemctl enable --now dlnprune
	
	cat << EOF > /etc/resolv.conf
# Generated by dln-config
domain wildfiredln.org
nameserver 10.0.0.1
EOF
	
	if [[ "$MODE" == "base" ]]; then
		sed -i "s/10\.0\.0\.1.*/10.0.0.1\t$HOST base manage/g" /etc/dlt/hosts
		systemctl enable --now dlnagent@base
		systemctl enable --now idms
		systemctl enable --now dnsmasq-intern@$MESHIF
	else
		systemctl enable --now dlnagent@ferry
		systemctl enable --now dlnloader
		systemctl enable --now dhcpcd
	fi
	read -p "Configuration changes require a system reboot, restart now? [y/N] " -n 1 -r
	echo
	if [[ $REPLY =~ ^[Yy]$ ]]; then
		reboot
	fi
fi
